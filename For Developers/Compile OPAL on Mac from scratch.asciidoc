= Compile OPAL on macOS from scratch
Achim Gsell
:doctype: article
:numbered:
:toc:
:toc-placement: preamble
:toclevels: 2

// Need some preamble to get TOC:
{empty}

'''
== Requirements

=== System requirements

* macOS 11.12 Sierra, macOS 10.13 High Sierra (still untestet)
* Xcode9
* Xcode command line tools

{nbsp}

=== Required software

The following packages must be build and installed, in parenthesis the recommended version we are using in our tool-chain:

* cmake >= 3.10.0 (maybe 3.9 will also wor
* Open MPI >= 1.10.2 (1.10.4)
* hdf5 >= 1.8.18 (1.8.18) 
* GNU Scientific Library >= 2.4 (2.4)
* H5hut >= 2.0.0rc3 (2.0.0rc3)
* boost >= 1.59 (1.62.0)

{nbsp}

=== Optional requirements
**If you want to run the unit tests, you need `google-test`:**

* gtest >= 1.7.0 (1.7.0)

{nbsp}

**If you want to compile OPAL with the  SAAMG solver:**

* ParMETIS >= 4 (4.0.3)
* OpenBLAS >= 0.2.9 (0.2.20)
* trilinos >= 12.10.1 (12.10.1)

{nbsp}

**If you want to compile H5hut with the VTK to H5hut mesh converter, you need:**

* VTK >= 7.1 (8.0.0)

'''
== Setting up the environment

To keep thinks simple, we set and use a couple of environment variables.

{nbsp}

`DOWNLOADS_DIR`::
 is the directory where we store downloaded files. In this instruction we use `${HOME}/Downloads`.

`PREFIX`::
is the common installation prefix for all software we have to compile and install. In the following instructions we use `${HOME}/software`.

`SRC_DIR`::
is the directory where we unpack and compile software. Here we use `${HOME}/src`.
`njobs`::
number of parallel `make` jobs. The number should be less or equal the number of core on your system plus one. If your system has more then 8 cores, setting `njobs`to eight is quite reasonable.
{nbsp}
[listing]
.Set environment variables and create used directories:
--
PREFIX="${HOME}/OPAL"
DOWNLOADS_DIR="${PREFIX}/Downloads"
SRC_DIR="${PREFIX}/src"

PATH="${PREFIX}/bin:${PATH}"

if [[ -z "${C_INCLUDE_PATH}" ]]; then
      C_INCLUDE_PATH="${PREFIX}/include"
else
      C_INCLUDE_PATH="${PREFIX}/include:${C_INCLUDE_PATH}"
fi

if [[ -z "${CPLUS_INCLUDE_PATH}" ]]; then
      CPLUS_INCLUDE_PATH="${PREFIX}/include"
else
      CPLUS_INCLUDE_PATH="${PREFIX}/include:${CPLUS_INCLUDE_PATH}"
fi

if [[ -z "${LIBRARY_PATH}" ]]; then
      LIBRARY_PATH="${PREFIX}/lib"
else
      LIBRARY_PATH="${PREFIX}/lib:${LIBRARY_PATH}"
fi

if [[ -z "${LD_LIBRARY_PATH}" ]]; then
      LD_LIBRARY_PATH="${PREFIX}/lib"
else
      LD_LIBRARY_PATH="${PREFIX}/lib:${LD_LIBRARY_PATH}"
fi

export C_INCLUDE_PATH
export CPLUS_INCLUDE_PATH
export LIBRARY_PATH
export LD_LIBRARY_PATH

NJOBS=4

mkdir -p "${PREFIX}"
mkdir -p "${PREFIX}/lib"
mkdir -p "${DOWNLOADS_DIR}"
mkdir -p "${SRC_DIR}"
--
'''

== Compile and install required software

Build the software in this order:

1. link:Recipes/cmake[CMake]
1. link:Recipes/openmpi[open-mpi]
1. link:Recipes/hdf5[HDF5]
1. link:Recipes/gsl[GSL]
1. link:Recipes/h5hut[H5hut]
1. link:Recipes/boost[Boost]
1. optional: link:Recipes/parmetis[ParMETIS] (required by Trilinos)
1. optional: link:Recipes/openblas[OpenBLAS] (required by Trilinos)
1. optional: link:Recipes/trilinos[Trilinos] (OPAL with SAAMG solver)

image::../images/note.png[]
=====================================================================
After setting up the environment the build instruction are the same for macOS and Linux!
=====================================================================

'''
== Building OPAL

1. **Get the OPAL sources**
+
Clone the OPAL Git repository
+
```
mkdir -p "${SRC_DIR}/OPAL"
cd "${SRC_DIR}/OPAL"
git clone git@gitlab.psi.ch:OPAL/src.git
```
+
Select the OPAL branch you want to compile. The current stable branch is `OPAL-1.6`:
+
```
cd "${SRC_DIR}/OPAL/src"
git checkout OPAL-1.6
```
+
To checkout the (unstable) development branch run:
+
```
cd "${SRC_DIR}/OPAL/src"
git checkout master
```
+
To get a list of all available branches, you can run the command
+
```
git branch -a
```
+
from inside your clone.
+

1. **Setup OPAL build environment**
+
The environment must be set up as described above for building the dependencies.
+
1. **Configure OPAL**
+
OPAL uses CMake to configure the build process. You can either pass options to `cmake` or you can run the command `ccmake` in the build directory **after** calling `cmake`.
+
--------------------------------------
mkdir -p "${SRC_DIR}/OPAL/build" && cd "$_"
CC=mpicc CXX=mpicxx cmake \
        --prefix="${PREFIX}" \
        "${SRC_DIR}/OPAL/src"
--------------------------------------
+
The following table shows the most important options:
+
[width="80%"]
|=======
| `CMAKE_BUILD_TYPE` | build type can be either `Debug`, `Release`, `RelWithDebInfo` or `MinSizeRel` 

| `CMAKE_INSTALL_PREFIX` | prefix for installation |
|=======

1. **Compile and install OPAL**
+
```
cd "${SRC_DIR}/OPAL/build"
make -j ${NJOBS}
make install
```

== Compile OPAL with the SAAMG solver

To compile OPAL with the SAAMG follow the steps in the section "Compile OPAL", but replace the configuration step with:
--------------------------------------
mkdir -p "${SRC_DIR}/OPAL/build"
cd "${SRC_DIR}/OPAL/build"
CC=mpicc CXX=mpicxx cmake \
        --prefix="${PREFIX}" \
        -D ENABLE_SAAMG_SOLVER=TRUE \
        "${SRC_DIR}/OPAL/src"
--------------------------------------
'''
